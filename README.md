# Strategic Insights from TMDB500 Movie Dataset Analysis

## Objective
Develop a comprehensive analysis framework using SQL to enhance decision-making in the film industry by uncovering insights into user engagement, budget optimization, genre-based recommendations, and optimal movie release dates based on the TMDB 5000 Movie Dataset with Ratings.

### Business Tasks:
* Explore whether specific genres lead to higher user engagement.
* Develop insights into the optimal budget range for different genres.
* Develop a model that suggests movies to users based on their historical ratings and preferences for specific genres.
* Analyze the relationship between movie release dates and revenue.

## Data Source:
The TMDB 5000 Movie Dataset with Ratings is a comprehensive compilation that combines the original TMDb 5000 Movie Dataset with additional user ratings, providing an in-depth exploration of the cinematic realm.

The dataset was obtained through [Kaggle](https://www.kaggle.com/datasets/aayushsoni4/tmdb-5000-movie-dataset-with-ratings?select=tmdb_movie_dataset.csv) a platform for data related competitions, datasets, and collaboration among data enthusiast.

    tmdb_movie_dataset:
        Columns:
            budget: The budget allocated for the movie.
            genres: Genres associated with the movie.
            homepage: The homepage URL of the movie.
            tmdbId: The unique identifier assigned by TMDb.
            keywords: Keywords or tags related to the movie.
            original_language: The original language of the movie.
            original_title: The original title of the movie.
            overview: A brief overview or synopsis of the movie.
            popularity: Popularity score of the movie.
            production_companies: Companies involved in the movie's production.
            production_countries: Countries where the movie was produced.
            release_date: The date when the movie was released.
            revenue: The revenue generated by the movie.
            runtime: The duration of the movie in minutes.
            spoken_languages: Languages spoken in the movie.
            status: The production status of the movie.
            tagline: A tagline associated with the movie.
            title: The title of the movie.
            vote_average: Average user rating.
            vote_count: The number of votes the movie received.
            ratingId: Unique identifier for ratings.

    tmdb_movie_credits:
        Columns:
            tmdbId: The unique identifier assigned by TMDb.
            title: The title of the movie.
            cast: Cast members of the movie.
            crew: Crew members involved in the movie.

    tmdb_movie_ratings:
        Columns:
            userId: Unique identifier for users.
            ratingId: Unique identifier for ratings.
            rating: User rating for the movie.
            timestamp: The timestamp when the rating was given.


## Process 

1. Automated uploading of dataset to posgresql through a python script

```python
# Library
import psycopg2
import pandas as pd
from sqlalchemy import create_engine, text

# Define the database connection parameters
db_params = {
    'host': 'xxxxxxxxx',
    'database': 'xxxxxxxxx',
    'user': 'xxxxxxxxx',
    'password': 'xxxxxxxxxx'
}

# Connect to the 'xxxxxxxx' database
db_params['database'] = 'xxxxxxxx'
engine = create_engine(f'postgresql://{db_params["user"]}:{db_params["password"]}@{db_params["host"]}/{db_params["database"]}')

# Define the file paths for your CSV files
csv_files = {
    'tmdb_movie_credits': '/home/tmdb_movie_credits.csv',
    'tmdb_movie_dataset': '/home/tmdb_movie_dataset.csv',
    'tmdb_movie_ratings': '/home/tmdb_movie_ratings.csv',
}

# Load and display the contents of each CSV file to check
for table_name, file_path in csv_files.items():
    print(f"Contents of '{table_name}' CSV file:")
    df = pd.read_csv(file_path)
    print(df.head(2))  # Display the first few rows of the DataFrame
    print("\n")

# Loop through the CSV files and import them into PostgreSQL
for table_name, file_path in csv_files.items():
    df = pd.read_csv(file_path)
    df.to_sql(table_name, engine, if_exists='replace', index=False)
```

2. Created a summarized table for further analysis

```sql
SELECT 
    tmdbid,
    title,
    AVG(rating) AS avg_rating,
    popularity,
    original_language,
    revenue,
    budget,
    revenue - budget AS profit,
    release_date,
    runtime
FROM tmdb_movie_dataset AS dataset 
FULL OUTER JOIN tmdb_movie_ratings AS rate
    ON dataset.ratingid = rate.ratingid
GROUP BY
    tmdbid,
    title,
    popularity,
    original_language,
    revenue,
    budget,
    release_date,
    runtime
ORDER BY popularity DESC, 1
```

## Analysis

1. Conducted exploratory data analysis

```sql
SELECT tmdbid, title, AVG(rating) AS avg_rating
FROM tmdb_movie_dataset AS dataset 
JOIN tmdb_movie_ratings AS rate
    ON dataset.ratingid = rate.ratingid
GROUP BY tmdbid, title
ORDER BY avg_rating DESC, 1
```

Top 10 highly rated-rated movies
```
 tmdbid |                    title                    |    avg_rating     
--------+---------------------------------------------+-------------------
  56491 | In Her Line of Fire                         |                 5
  67373 | This Thing of Ours                          |                 5
  73511 | The Californians                            |                 5
 112937 | The Oogieloves in the Big Balloon Adventure |                 5
 170480 | The Deported                                |                 5
 248402 | A Fine Step                                 |                 5
 362765 | The Sound and the Shadow                    |              4.75
  89540 | The Other Conquest                          |               4.5
    278 | The Shawshank Redemption                    | 4.413576004516335
    238 | The Godfather                               | 4.324336165187245
(10 rows)
```

```sql
SELECT tmdbid, title, popularity
FROM tmdb_movie_dataset
GROUP BY tmdbid, title, popularity
ORDER BY 3 DESC
LIMIT 10
```

Top 10 most popular movies
```
 tmdbid |                         title                          | popularity 
--------+--------------------------------------------------------+------------
 211672 | Minions                                                | 875.581305
 157336 | Interstellar                                           | 724.247784
 293660 | Deadpool                                               | 514.569956
 118340 | Guardians of the Galaxy                                | 481.098624
  76341 | Mad Max: Fury Road                                     | 434.278564
 135397 | Jurassic World                                         | 418.708552
     22 | Pirates of the Caribbean: The Curse of the Black Pearl | 271.972889
 119450 | Dawn of the Planet of the Apes                         | 243.791743
 131631 | The Hunger Games: Mockingjay - Part 1                  | 206.227151
 177572 | Big Hero 6                                             |  203.73459
(10 rows)
```

Utilized common table expression (CTE) to simplify query
```sql
WITH movie_data_cte AS (
    SELECT 
        tmdbid,
        title,
        AVG(rating) AS avg_rating,
        popularity,
        original_language,
        revenue,
        budget,
        revenue - budget AS profit,
        release_date,
        runtime
    FROM tmdb_movie_dataset AS dataset 
    FULL OUTER JOIN tmdb_movie_ratings AS rate
        ON dataset.ratingid = rate.ratingid
    GROUP BY
        tmdbid,
        title,
        popularity,
        original_language,
        revenue,
        budget,
        release_date,
        runtime
)
SELECT title, revenue, budget, profit
FROM movie_data_cte
WHERE revenue IS NOT NULL AND budget IS NOT NULL
ORDER BY profit DESC
LIMIT 10
```

Top 10 most profitable movies
```
                     title                     |  revenue   |  budget   |   profit   
-----------------------------------------------+------------+-----------+------------
 Avatar                                        | 2787965087 | 237000000 | 2550965087
 Titanic                                       | 1845034188 | 200000000 | 1645034188
 Jurassic World                                | 1513528810 | 150000000 | 1363528810
 Furious 7                                     | 1506249360 | 190000000 | 1316249360
 The Avengers                                  | 1519557910 | 220000000 | 1299557910
 Avengers: Age of Ultron                       | 1405403694 | 280000000 | 1125403694
 Frozen                                        | 1274219009 | 150000000 | 1124219009
 Minions                                       | 1156730962 |  74000000 | 1082730962
 The Lord of the Rings: The Return of the King | 1118888979 |  94000000 | 1024888979
 Iron Man 3                                    | 1215439994 | 200000000 | 1015439994
(10 rows)
```

2. Identifying which genres are highly rated and most popular

```sql
SELECT 
    jsonb_array_elements(genres::jsonb)->>'name' AS genre,
    AVG(popularity) AS avg_popularity,
    AVG(rating) AS avg_rating
FROM tmdb_movie_dataset AS data
JOIN tmdb_movie_ratings AS rate
    ON data.ratingid = rate.ratingid
GROUP BY genre
ORDER BY avg_rating DESC
```

Top highly-rated genres
```
      genre      |   avg_popularity   |     avg_rating     
-----------------+--------------------+--------------------
 History         | 43.357770533180826 | 3.8316396875556658
 War             |  51.22959021776805 | 3.8042976968275415
 Drama           |  46.25049398999156 | 3.7073152500146063
 Western         |  41.56722002020875 | 3.6784805198694337
 Documentary     |   10.4483702533582 | 3.6577261299869526
 Crime           |   48.9111862154199 |  3.654128526258092
 Animation       |  68.14803192662754 | 3.6122022296361997
 Music           |  25.03776048558095 |  3.582330592677522
 Mystery         |  46.69926936400489 | 3.5590204452205176
 Romance         | 36.571375590277206 |  3.534069022383935
 Thriller        | 48.990826708496385 |  3.533170686528364
 Foreign         | 0.9046032049180238 | 3.5296343001261032
 Family          | 56.838284647906484 |  3.503765654783311
 Adventure       |  68.31252331967922 | 3.5005963140752314
 Science Fiction |   65.1207316150608 | 3.4897802847123787
 Action          | 60.630644611993596 |  3.478096870989073
 Fantasy         |   63.2040868753253 |  3.469406228038329
 Comedy          |  38.00130228690431 | 3.4241623657708073
 Horror          | 38.162355249017466 | 3.2738222845142695
 TV Movie        | 12.237788070690621 |  3.234908657664813
(20 rows)
```

Most popular genres
```
      genre      |   avg_popularity   |     avg_rating     
-----------------+--------------------+--------------------
 Adventure       |  68.31252331968044 | 3.5005963140752314
 Animation       |  68.14803192662754 | 3.6122022296361997
 Science Fiction |  65.12073161506049 | 3.4897802847123787
 Fantasy         |  63.20408687531666 |  3.469406228038329
 Action          |  60.63064461199355 |  3.478096870989073
 Family          |  56.83828464790374 |  3.503765654783311
 War             |  51.22959021776805 | 3.8042976968275415
 Thriller        | 48.990826708496385 |  3.533170686528364
 Crime           |  48.91118621541991 |  3.654128526258092
 Mystery         | 46.699269364004486 | 3.5590204452205176
 Drama           | 46.250493989991526 | 3.7073152500146063
 History         | 43.357770533180826 | 3.8316396875556658
 Western         |  41.56722002020875 | 3.6784805198694337
 Horror          |  38.16235524901887 | 3.2738222845142695
 Comedy          | 38.001302286909365 | 3.4241623657708073
 Romance         |  36.57137559027641 |  3.534069022383935
 Music           |  25.03776048558095 |  3.582330592677522
 TV Movie        | 12.237788070690621 |  3.234908657664813
 Documentary     |   10.4483702533582 | 3.6577261299869526
 Foreign         | 0.9046032049180238 | 3.5296343001261032
(20 rows)
```

3. Identification of the optimal budget per genre to maximize profit

```sql
SELECT
    jsonb_array_elements(genres::jsonb)->>'name' AS genre,
    AVG(revenue) AS avg_revenue,
    AVG(budget) AS avg_budget,
    AVG(revenue) - AVG(budget) AS avg_profit
FROM tmdb_movie_dataset AS data
JOIN tmdb_movie_ratings AS rate
    ON data.ratingid = rate.ratingid
GROUP BY genre
ORDER BY avg_revenue DESC
```

Most profitable genre: Avg. revenue vs. Avg. budget vs. Avg Profit
```
      genre      |      avg_revenue       |      avg_budget       |          avg_profit           
-----------------+------------------------+-----------------------+-------------------------------
 Animation       |     425254815.22771755 | 82642757.728188865921 |        342612057.499528684079
 Adventure       |     416642349.72284679 | 80711469.748972380609 |        335930879.973874409391
 Family          |     381218084.41278300 | 69368042.311818629154 |        311850042.100964370846
 Fantasy         |     374601595.12113654 | 72610548.963476244251 |        301991046.157660295749
 Action          |     338705831.12709995 | 76117253.903351359944 |        262588577.223748590056
 Science Fiction |     337494342.99389016 | 69950109.546914652886 |        267544233.446975507114
 Thriller        |     215728316.75111338 | 53290614.195991510913 |        162437702.555121869087
 Mystery         |     201057627.40482981 | 47204260.998454373054 |        153853366.406375436946
 War             |     197317717.71062095 | 43671736.671541378258 |        153645981.039079571742
 Romance         |     186097753.33741536 | 30841299.513138521865 |        155256453.824276838135
 Comedy          |     179207408.93771475 | 36706109.054055509710 |        142501299.883659240290
 Western         |     171358756.32317028 | 39620816.747974874974 |        131737939.575195405026
 Drama           |     170888396.07772841 | 36868228.699865755098 |        134020167.377862654902
 History         |     169896791.50604453 | 42081091.753015250526 |        127815699.753029279474
 Crime           |     159382977.66885633 | 38640799.961795859344 |        120742177.707060470656
 Horror          |     107862384.72601009 | 24541136.762454658478 |         83321247.963555431522
 Music           |  94735859.607370114631 | 23731231.061488453985 |         71004628.545881660646
 Documentary     |  35366152.078009143851 |  3443482.949676995046 |         31922669.128332148805
 Foreign         |   1056079.936002522068 |   711640.947036569987 |           344438.988965952081
 TV Movie        | 0.00000000000000000000 |  1967037.331215250199 | -1967037.33121525019900000000
(20 rows)
```

4. Analysis of various movie preferences by each users

To recommend movie titles per user, I've analyzed the genre preferences of each user based on the movies they've rated. I've utilized Common Table Expressions (CTEs) to perform multiple JOIN operations. The CTE is primarily responsible for extracting values from a column named 'genres', which is of JSON type.

```sql
WITH genres_cte AS (
    SELECT
        tmdbid,
        title,
        jsonb_array_elements(genres::jsonb)->>'name' AS genre
    FROM tmdb_movie_dataset
)
SELECT
    rate.userid,
    genres_cte.genre,
    AVG(rate.rating) AS avg_rate,
    AVG(popularity) AS avg_popularity
FROM tmdb_movie_dataset AS data
JOIN tmdb_movie_ratings AS rate
    ON rate.ratingid = data.ratingid
JOIN genres_cte
    ON data.tmdbid = genres_cte.tmdbid
GROUP BY rate.userid, genres_cte.genre 
    HAVING rate.userid = 2
ORDER BY 1 ASC, 3 DESC
```

Genre preference of userid no. 2
```
 userid |      genre      |      avg_rate      |   avg_popularity   
--------+-----------------+--------------------+--------------------
      2 | Crime           |              4.375 |  55.72506308333333
      2 | Mystery         |              4.375 |        54.45288375
      2 | Horror          |                  4 |          25.881355
      2 | Thriller        |                  4 |  44.25550815384615
      2 | History         | 3.9642857142857144 |  39.09598614285714
      2 | Adventure       | 3.9491525423728815 | 58.749567661016954
      2 | Fantasy         | 3.9285714285714284 |  70.93653342857142
      2 | Animation       |  3.923076923076923 |           72.19708
      2 | Action          |               3.91 |        59.59852512
      2 | Science Fiction | 3.8703703703703702 | 51.454721592592605
      2 | Family          | 3.7096774193548385 | 55.067616516129036
      2 | Drama           |             3.6875 |    40.157383390625
      2 | War             |             3.6875 | 52.580375499999995
      2 | Comedy          | 3.5285714285714285 | 44.523727685714285
      2 | Romance         | 3.0961538461538463 |         32.6797835
      2 | Western         |                2.7 | 31.493327800000003
      2 | Music           |                  2 | 21.816380000000002
(17 rows)
```

Genre preference of userid no. 51
```
 userid |      genre      | avg_rate |  avg_popularity   
--------+-----------------+----------+-------------------
     51 | War             |      4.5 |         60.722162
     51 | History         |      4.5 |         60.722162
     51 | Comedy          |        4 |         73.640445
     51 | Family          |        4 |         73.640445
     51 | Animation       |        4 |         73.640445
     51 | Mystery         |        4 |        70.1473415
     51 | Action          |     3.75 | 74.94863899999999
     51 | Adventure       |      3.5 | 86.45138299999999
     51 | Thriller        |      3.5 |        67.4830416
     51 | Drama           |      3.5 |        75.4928068
     51 | Science Fiction |      3.5 | 86.45138299999999
     51 | Crime           |    3.375 |       78.55711275
     51 | Fantasy         |        3 |        103.698022
(13 rows)
```

With the available data on each user's genre preferences, I've conducted a query to identify the top-rated movie titles suitable for recommendation to a particular user. To ensure high-quality recommendations, I've filtered the movie titles to include only those with an average rating of at least 4.0.

```sql
WITH genres_cte AS (
    SELECT
        tmdbid,
        title,
        jsonb_array_elements(genres::jsonb)->>'name' AS genre
    FROM tmdb_movie_dataset
)
SELECT
    rate.userid,
    genres_cte.genre,
    AVG(rate.rating) AS avg_rate,
    AVG(popularity) AS avg_popularity
FROM tmdb_movie_dataset AS data
JOIN tmdb_movie_ratings AS rate
    ON rate.ratingid = data.ratingid
JOIN genres_cte
    ON data.tmdbid = genres_cte.tmdbid
GROUP BY rate.userid, genres_cte.genre 
    HAVING rate.userid = 2
ORDER BY 1 ASC, 3 DESC
LIMIT 200


-- lists of movie titles suggestion per user based on their genre preference
WITH movie_recommendation AS (
    WITH user_preference_cte AS (
        WITH genres_cte AS (
            SELECT
                tmdbid,
                title,
                jsonb_array_elements(genres::jsonb)->>'name' AS genre
            FROM tmdb_movie_dataset
        )
        SELECT
            rate.userid,
            genres_cte.genre,
            AVG(rate.rating) AS avg_rate,
            AVG(popularity) AS avg_popularity
        FROM tmdb_movie_dataset AS data
        JOIN tmdb_movie_ratings AS rate
            ON rate.ratingid = data.ratingid
        JOIN genres_cte
            ON data.tmdbid = genres_cte.tmdbid
        GROUP BY rate.userid, genres_cte.genre 
    )
    SELECT title, avg_rating, titles_per_genre.genre
    FROM (
        SELECT
            tmdbid,
            title,
            AVG(rating) AS avg_rating,
            jsonb_array_elements(genres::jsonb)->>'name' AS genre
        FROM tmdb_movie_dataset AS data
        JOIN tmdb_movie_ratings AS rate
            ON data.ratingid = rate.ratingid
        GROUP BY tmdbid, title, genre
    ) AS titles_per_genre
    JOIN user_preference_cte
        ON titles_per_genre.genre = user_preference_cte.genre
    WHERE userid = 2 AND avg_rate >= 4 AND avg_rating >= 4
    ORDER BY 2 DESC
    LIMIT 20
)
SELECT
    movie_recommendation.title,
    movie_recommendation.avg_rating
FROM movie_recommendation
GROUP BY title, avg_rating
ORDER BY avg_rating DESC
LIMIT 10
```

Top movie title recommendation for userid No. 2
```
          title           |     avg_rating     
--------------------------+--------------------
 In Her Line of Fire      |                  5
 This Thing of Ours       |                  5
 The Sound and the Shadow |               4.75
 The Shawshank Redemption |  4.413576004516335
 The Godfather            |  4.324336165187245
 The Usual Suspects       |  4.284353213163313
 The Godfather: Part II   | 4.2617585117585115
 Born Of War              |               4.25
 The Lives of Others      |  4.200392285060477
 Pulp Fiction             |  4.188912039361382
(10 rows)
```

Top movie title recommendation for userid No. 51
```
                                title                                 |    avg_rating     
----------------------------------------------------------------------+-------------------
 The Californians                                                     |                 5
 The Deported                                                         |                 5
 The Oogieloves in the Big Balloon Adventure                          |                 5
 The Sound and the Shadow                                             |              4.75
 Born Of War                                                          |              4.25
 Good Intentions                                                      |              4.25
 The Last Big Thing                                                   |              4.25
 Schindler's List                                                     | 4.247579083279535
 Dr. Strangelove or: How I Learned to Stop Worrying and Love the Bomb | 4.215804447106386
 Spirited Away                                                        | 4.212267265284564
(10 rows)
```

5. Determining the ideal month for releasing a movie.

Initially, it's worthwhile to assess the total number of movie titles per month of release. Utilizing SQL's PARTITION BY feature, I segmented the count of movie titles by month.

```sql
SELECT
    DISTINCT(release_month),
    COUNT(release_month) OVER (PARTITION BY release_month) AS movie_count
FROM (
    SELECT
        tmdbid,
        title,
        EXTRACT(MONTH FROM release_date::DATE) AS release_month
    FROM tmdb_movie_dataset
    ) AS movie_per_month
ORDER BY movie_count DESC
```

Top months with most movie released
```
 release_month | movie_count 
---------------+-------------
             9 |         568
            10 |         449
            12 |         446
             8 |         403
             6 |         376
             3 |         356
             1 |         351
             5 |         346
             7 |         344
             4 |         330
            11 |         318
             2 |         315
(12 rows)
```

To identify the month with the highest grossing revenue, I partitioned the average revenue per month.

```sql
SELECT
    DISTINCT(release_month),
    AVG(revenue) OVER (PARTITION BY release_month) AS avg_revenue
FROM (
    SELECT
        tmdbid,
        title,
        revenue,
        EXTRACT(MONTH FROM release_date::DATE) AS release_month
    FROM tmdb_movie_dataset
    WHERE revenue > 0
    ) AS movie_per_month
ORDER BY avg_revenue DESC
```

Top grossing month
```
 release_month |      avg_revenue      
---------------+-----------------------
             6 |    198122700.05016722
             5 |    190339023.16470588
            11 |    159759462.68060837
            12 |    148051475.78134111
             7 |    147955088.08394161
             4 |    111420815.03879310
             3 |    111117826.08571429
            10 | 79591425.795454545455
             2 | 77810151.314893617021
             8 | 76315772.268211920530
             9 | 58720822.122500000000
             1 | 54429995.720812182741
(12 rows)
```
